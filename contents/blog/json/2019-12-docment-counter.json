{
  "title": "VueCLIとFirebaseを使って、原稿用紙の下書きができて締め切りを通知してくれるアプリをつくってみた",
  "created_at": "2019-12-17T00:00:00.000Z",
  "slug": "docment-counter",
  "category": {
    "name": "tech",
    "slug": "tech"
  },
  "tags": [
    {
      "name": "Vue.js",
      "slug": "vue"
    }
  ],
  "description": "Vue.jsとFirebaseを利用してPWAでPush通知がくるメモアプリを作成してみました。ざっくり実装したことなどをご紹介しますm(_ _)m",
  "bodyContent": "この記事は[North Detail Advent Calendar 2019](https://qiita.com/advent-calendar/2019/northdetail)17日目の記事です。\n\n\n*※説明のためにいくつかコードを載せていますが、実際に作成したアプリのコード(Github)とは似て異なります。*\n\n## 概要\n学生時代に手書きレポートの下書きをPCで打ち込んでいたのですが、実際にマス目に当てはめると段落の切り替えや、数字を1マスに2つ入れる...etcなどのルールがあったりして、文字数＝マス目の数にならないので、PCで下書きをして文字数を原稿用紙にあわせても、結局文章の長さが多すぎたり、逆に足りなかったりすることが多々ありました。\nということで、打ち込んだ文章を原稿用紙に当てはめたようにして表示するアプリを作成してみました。\n\n## 作ったもの\n\n- 入力した文章が原稿用紙に収まるかどうかを、実際にマス目に納めてカウントします。\n- ログインするとカウントした結果を保存することができます。\n- 締切日を設定すると締め切り前日と当日にPush通知が届きます。(8:00と17:00に通知)\n\n![スクリーンショット 2019-12-04 19.01.40（2）.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/538820/de3542d5-7b5f-635e-3c38-5d11d3c3e53b.png)\n![スクリーンショット 2019-12-04 19.02.23（2）.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/538820/a9ae857f-336a-5aa3-bd04-ccbe8f39dda3.png)\n\n\n\n文字数オーバーした箇所は赤いマスで表示されます。\n「段落の頭を1マス開ける」、「括弧を他の文字と同じますに入れる」など、実際の原稿用紙のルールに則った書式設定ができるので、打った文章が原稿用紙何枚分に収まるのかを確認することができます。\n\n- [Demo](https://document-paper-counter-81e10.firebaseapp.com/)\n- [Git](https://github.com/shunsato1231/document-paper-counter)\n\n## 実装した機能と、実装内容の概要\n### 文字のカウント\n1. 入力した本文と、原稿用紙の書式設定をVuex Storeに格納\n2. Vuexのアクションで入力した文字を配列に分割し、(配列1つに原稿用紙ひとます分の文字を格納)Vuex Storeに格納\n3. 配列に格納された文字を原稿用紙風に表示\n\n### カウントした文章の保存\n入力した文章と、原稿用紙の書式設定をFireStoreにて管理。\n\n### 通知処理\n1. 原稿用紙風に表示する画面で、「通知する」チェックボックスを押した時に通知用のトークンを取得\n2. 保存時に、通知用のトークンを保存\n3. FirebaseFunctionsでpush通知を送信する関数を作成\n3. 外部のCronを利用して、毎日8:00と17:00にFirebaseFunctionsで作成したpush通知を送信する関数を実行\n\n\n## 実装の手順\n\n大まかにですが、実装の手順について紹介しようと思います。\n\n## 1. プロジェクトの作成\nyarnがインストールされている前提です。\n\n### 1-1. Vue Cliを使ってプロジェクト作成\n\n```sh\n// vueCLIをインストール\nyarn global add @vue/cli\n\n// 新規プロジェクト作成\nvue create <プロジェクト名>\n```\n上記コマンドでプロジェクトを作成。\n\nデフォルトのプリセットを使うか、手動で選択するかを聞かれるので `Manually select features` を選択。\n\n```sh\n? Please pick a preset: \n  default (babel, eslint) \n❯ Manually select features \n```\n\n続く設問も下記のように選択。\n\n```sh\n? Check the features needed for your project: \n❯ ◉ Babel\n  ◯ TypeScript\n❯ ◉ Progressive Web App (PWA) Support\n❯ ◉ Router\n❯ ◉ Vuex\n❯ ◉ CSS Pre-processors\n❯ ◉ Linter / Formatter\n  ◯ Unit Testing\n  ◯ E2E Testing\n\n? Use history mode for router? (Requires proper server setup for index fallback in production)\n❯ Yes\n\n? Pick a CSS pre-processor (PostCSS, Autoprefixer and CSS Modules are supported by default)\n❯ Scss\n\n? Pick a linter / formatter config\n❯ ESLint with error prevention only \n\n? Pick additional lint features: (Press <space> to select, <a> to toggle all, <i> to invert selection)\n❯ Lint on save\n\n? Where do you prefer placing config for Babel, PostCSS, ESLint, etc.? \n❯ In dedicated config files\n```\n\n\nこれでVueプロジェクトの雛形が生成されるので、下記コマンドを実行するとアプリを立ち上げることができます。\n\n```sh\n// プロジェクトフォルダに移動\ncd <プロジェクト名>\n\n// ローカルで実行\nyarn run serve\n```\n\n\n### 1-2. Firebase導入\n- [Firebaseコンソール](https://firebase.google.com/?hl=ja)にアクセスし、Firebaseのアカウントを作成\n- Firebaseコンソール「新規プロジェクト作成」から新規プロジェクトを追加する。\n- Firebaseをプロジェクトにインストール\n\n```sh\n//Firebaseインストール\n$ yarn global add firebase-tools\n\n// Googleアカウントでログイン\n$ firebase login\n\n// Firebaseの設定\n$ firebase init\n\n? Which Firebase CLI features do you want to setup for this folder? Press Space to select features, then Enter to confirm your choices.\n ◯ Database: Deploy Firebase Realtime Database Rules\n ◉ Firestore: Deploy rules and create indexes for Firestore\n ◉ Functions: Configure and deploy Cloud Functions\n ◉ Hosting: Configure and deploy Firebase Hosting sites\n ◯ Storage: Deploy Cloud Storage security rules\n\n? Select a default Firebase project for this directory: (Use arrow keys)\n❯ document-paper-counter-81e10 (document-paper-counter) // コンソールで作成したプロジェクト選択\n\n```\n\nFireStoreの設定はデフォルトのまま\n\n```sh\n=== Firestore Setup\n\nFirestore Security Rules allow you to define how and when to allow\nrequests. You can keep these rules in your project directory\nand publish them with firebase deploy.\n\n? What file should be used for Firestore Rules? firestore.rules\n\n\nFirestore indexes allow you to perform complex queries while\nmaintaining performance that scales with the size of the result\nset. You can keep index definitions in your project directory\nand publish them with firebase deploy.\n\n? What file should be used for Firestore indexes? firestore.indexes.json\n\n\n=== Functions Setup\n\nA functions directory will be created in your project with a Node.js\npackage pre-configured. Functions can be deployed with firebase deploy.\n\n? What language would you like to use to write Cloud Functions? JavaScript\n? Do you want to use ESLint to catch probable bugs and enforce style? No\n✔  Wrote functions/package.json\n✔  Wrote functions/index.js\n✔  Wrote functions/.gitignore\n? Do you want to install dependencies with npm now? Yes\n```\n\nHostingの設定は下記のように設定\n\n```\"lang\":\"shell\",\"number\":false,\"title\":false\n=== Hosting Setup\n\nYour public directory is the folder (relative to your project directory) that\nwill contain Hosting assets to be uploaded with firebase deploy. If you\nhave a build process for your assets, use your build's output directory.\n\n? What do you want to use as your public directory? dist\n? Configure as a single-page app (rewrite all urls to /index.html)? Yes\n```\n\n\n- config情報を管理画面から取得(今回はGitにコードをあげるために環境変数に格納)\n- main.jsで```firebase.initializeApp```を実行\n\n```\"lang\":\"javascript\",\"title\":\"main.js\"\n\nimport firebase from 'firebase/app'\n\n// initialize Firebase\nlet config = {\n  apiKey: process.env.VUE_APP_FIRE_BASE_apiKey,\n  authDomain: process.env.VUE_APP_FIRE_BASE_authDomain,\n  databaseURL: process.env.VUE_APP_FIRE_BASE_databaseURL,\n  projectId: process.env.VUE_APP_FIRE_BASE_projectId,\n  storageBucket: process.env.VUE_APP_FIRE_BASE_storageBucket,\n  messagingSenderId: process.env.VUE_APP_FIRE_BASE_messagingSenderId,\n  appId: process.env.VUE_APP_FIRE_BASE_appId\n}\n\nfirebase.initializeApp(config)\n...略\n```\nこれで、Firebaseの初期設定ができました。\n\n### 1-3. フォルダ構成\n\nこれらの手順で生成されたものを元に、大まかに下記のようなフォルダ構成で作成しました。\n\n```\n├── dist\n│   └── ビルド後に生成されるファイル\n│\n├── firebase.json\n├── firestore.indexes.json\n├── firestore.rules\n├── functions\n│   ├── index.js\n│   ├── package-lock.json\n│   └── package.json\n│\n├── public\n│   ├── 404.html\n│   ├── favicon.ico\n│   ├── firebase-messaging-sw.js\n│   ├── img\n│   │   └── icons\n│   ├── index.html\n│   ├── manifest.json\n│   └── robots.txt\n├── src\n│   ├── App.vue\n│   ├── main.js\n│   ├── registerServiceWorker.js\n│   ├── api\n│   │   └── firebase.js\n│   ├── assets\n│   │   └── scss\n│   │       └── entry.scss\n│   ├── components\n│   │   ├── dialog.vue\n│   │   └── head-menu.vue\n│   ├── pages\n│   │   ├── help.vue\n│   │   ├── input.vue\n│   │   ├── list.vue\n│   │   └── result.vue\n│   ├── router\n│   │   └── index.js\n│   └── store\n│       ├── index.js\n│       └── modules\n│           ├── auth.js\n│           ├── counter.js\n│           └── list.js\n└── vue.config.js\n```\n\n![vuex.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/538820/935f9faa-6bc9-0050-ba08-8c1b879c9bf0.png)\n引用元: https://vuex.vuejs.org/ja/\n\n上記の図の、```VueComponents```に当たる部分が```src/components```と```src/pages```になります。\n```vuex```に当たる部分が```store```内に格納されているものです。\n今回の場合、```BackendAPI```に当たる部分がFirebaseになるため、Firebaseに関する関数を```src/api/firebase.js```に集約し、```store```フォルダ内のコードから呼び出す方針で実装しました。\n\n## 2. VueでUI部分を作成\n今回ここについては省略します。\n\n\n\n## 3. Authentication(ログイン処理)\n今回はGoogleアカウントで認証できるように実装しました。\n\n```javascript\n...略\n\nconst auth = firebase.auth()\n\nexport default {\n  initFirebase () {\n    auth.onAuthStateChanged(this.onAuthStateChanged.bind(this))\n  },\n\n  login () {\n    var provider = new firebase.auth.GoogleAuthProvider()\n    auth.signInWithPopup(provider)\n  },\n\n  logout () {\n    auth.signOut()\n  },\n\n  onAuthStateChanged (user) {\n    if (user) {\n     // ユーザがログインしている時の処理\n    } else {\n     // 未ログイン時の処理\n    }\n  },\n\n...略\n```\n\n```main.js``` に以下を追加\n\n```\"lang\":\"javascript\",\"title\":\"main.js\"\nimport Firebase from './api/firebase'\n\nFirebase.initFirebase()\n```\n\nこの処理だけでGoogleアカウントでの認証が完了しました。\n\n## 4. FireStore(データベース)への書き込み\n以前使われていたFirebaseRealtimeDatabaseではデータベース構造をjsonファイルで記述する必要がありましたが、FireStoreでは書き込みのルールのみ指定すれば、自由にカラムを作成できるようです。\n\n```javascript\n...略\nimport 'firebase/firestore'\nexport default {\n  //例) 原稿のデータをfirestoreに保存する関数\n  saveDocument (document) {\n    return new Promise((resolve, reject) => {\n      const userId = VueCookies.get('userInfo').uid // cookieに保存しておいたユーザIDを取得\n      database.collection('users').doc(userId).collection('documents')\n        .add(document)\n        .then((ref) =>  {\n          resolve(ref)\n        }).catch(reject)\n    })\n  },\n}\n```\n\n## 5. CloudMessagingを利用したPush通知\n\n※Push通知に関してはSafariやiOS端末などでは非対応です。iPhoneでは通知を出せません。\n\n### 5-1. PWA化をしてCloudMessagingを導入する\n\nPWA化とCloudMessagingの導入に関しては、下記記事を参考に実装しました。\n\n- [Vue CLI 3 で PWA チュートリアル（Service Workers / Add to Home Screen / Push Notifications）](https://qiita.com/n11sh1/items/5d64c337ef927ac8d5d6#push-notifications)\n\n\n注意点として、\n\n```javascript\n... 略\nlet messaging\n\nif(firebase.messaging.isSupported()) {\n  messaging = firebase.messaging()\n}\n\nexport default {\n  initFirebase () {\n    auth.onAuthStateChanged(this.onAuthStateChanged.bind(this))\n\n    if (firebase.messaging.isSupported()) {\n      messaging.usePublicVapidKey(process.env.VUE_APP_FIRE_BASE_publicVapidKey)\n      store.dispatch('auth/checkMessagingisSupported', true)\n    } else {\n      store.dispatch('auth/checkMessagingisSupported', false)\n    }\n  },\n...略\n```\n\n上記のように```firebase.messaging.isSupported()```関数でCloudMessagingに対応した環境かどうかを判定しないと\niOS端末など、CloudMessageingが非対応の環境ではページがまっしろになってしまいます。\n\n### 5-2. Push通知をするためのトークンを発行する\n複数の端末でログインしても、全ての端末にpush通知が届くように、複数端末トークンを利用しました。\n\n参考ページ\n- https://firebase.google.com/docs/cloud-messaging/js/device-group?hl=ja\n\nトークン追加のURLをそのまま叩くと、クロスドメイン制約に引っかかってしまうため、下記のエラーが出てしまいます。\n\n```sh\nAccess-Control-Allow-Origin \n```\n\nそこで、プロキシの設定をします。\n```vue.config.js```に下記の設定を追加。\n\n```javascript\nmodule.exports = {\n    ...略\n    devServer: {\n        proxy: 'https://fcm.googleapis.com/',\n    }\n  }\n```\nこれで、\n```<アプリが立ち上がっているサーバのドメイン>/hoge/some```\nにリクエストを飛ばすと、devserverを経由して\n```https://fcm.googleapis.com/hoge/some```\nにリクエストが送信されるようになります。\n\n実際には、開発環境と本番環境でドメインが違うので、環境変数にドメインを格納します。\n\n\n.envファイルに本番環境のドメインを変数で追加\n\n```javascript\nVUE_APP_API_URL_BASE=\"<デプロイする先のドメイン>\"\n```\n\n.env.developファイルに、開発環境(localhost)のドメインを追加\n\n```javascript\nVUE_APP_API_URL_BASE=\"http://localhost:8080\"\n```\n\nこれで、ドメイン部分を変数で指定すると、開発環境でも、本番環境でも、クロスドメイン制約に引っかかることなくリクエストを叩けるようになりました。\n\n```javascript\n...略\n  // 通知用トークンの取得\n  getNotinotificationKey () {\n    const userId = VueCookies.get('userInfo').uid\n    const url = process.env.VUE_APP_API_URL_BASE + \"/fcm/notification?notification_key_name=\" + userId\n    let headers = {\n      'Content-Type':'application/json',\n      'Authorization': 'key=' + process.env.VUE_APP_FIRE_BASE_serverKey,\n      'project_id': process.env.VUE_APP_FIRE_BASE_messagingSenderId\n    }\n    return new Promise((resolve, reject) => {\n      axios.get(url, {headers: headers, data: {}})\n        .then(res => {\n          resolve(res.data)\n        }).catch(err => {\n          reject(err)\n        })\n    })\n  },\n...略\n```\n\n### 5-3. CloudFunctionsで通知を送るfunctionを作成\n```functions/index.js``` に通知を送信するfunctionを作成して、deployします。\n\n```javascript\n\n// firestoreにから通知対象のデータと、トークンを取得\nasync function getNotificationDocument () {\n  try {\n    // notificationListに通知するデータを格納済み\n    const querySnapshot = await database.collection('notificationList').get()\n\n    return querySnapshot.docs.filter(doc => {\n      return moment().isSame(doc.data().deadline, 'day')\n    }).map(doc => {\n      return {\n        notificationKey: doc.data().notificationKey,\n        title: doc.data().title,\n        id: doc.id\n      }\n    })\n  } catch (error) {\n    throw error\n  }\n}\n\n// push通知を送信する\nasync function DeadlineDocument(documents) {\n  const url = \"https://fcm.googleapis.com/fcm/send\"\n  const headers = {\n    'Authorization': 'key=' + functions.config().vue_app.server_key,\n  }\n\n  try{\n    for(let document of documents) {\n      let data = {\n        \"notification\": {\n          \"title\": \"「\" + document.title + \"」は今日締め切りです\", //通知のタイトル\n          \"click_action\": \"result/\" + document.id //通知を押した時の飛び先\n        },\n        \"to\": document.notificationKey //トークン\n      }\n\n      axios.post(url, data, {headers: headers, useCredentails: true})\n\n      await sleep(2000)\n    }\n\n    return documents\n  } catch (error) {\n    throw error.response.status\n  }\n}\n\n// デプロイする関数\nexports.pushNotification = functions.https.onRequest(async (request, response) => {\n  try{\n    const res = await getNotificationDocument()\n    const today = await pushNotificationTodaysDeadlineDocument(res.today)\n    response.send(today)\n  } catch (error) {\n    response.status(500).send(error)\n  }\n})\n```\n\n下記コマンドでfunctionをデプロイ\n\n```sh\n$ firebase deploy --only functions\n\nFunction URL (addMessage): https://MY_PROJECT.cloudfunctions.net/pushNotification\n```\n\nFunctionURLをブラウザで開いて、push通知が送信されれば成功です◎\n\n### 5-4. Cronで関数を定期実行\nFirebaseのみで定期実行をすることができますが、課金が必要です。\nhttps://firebase.google.com/docs/functions/schedule-functions\n\n今回は、無料で実装したかったため、外部のCronを利用しました。\n\n- [cron-job.org](https://cron-job.org/en/)にアクセスし、TOP画面でサインアップする\n- 「Cronjobs」タブの「+Create cronjob」ボタンを押して、新規jobを作成\n- titleとFunctionURL、任意のスケジュールを設定し、jobを作成\n\nこれで設定がうまくいっていれば、設定したスケジュールで通知されます🎉\n\n## 感想\nCloudMessagingは初めて利用しましたが、想像以上に簡単にpush通知を実装することができました。\nPWA化もVueCLIを利用すれば、手間無く実装できました。\n\nPWAはiOSの対応状況が芳しくないので、今後に期待です。。。😔\n\n原稿用紙の表示部分は思いつきとチカラワザで実装したので、バグがあるかもしれないです。。\n不具合など見つけたらご指摘いただけると助かりますm(_ _)m",
  "bodyHtml": "<p>この記事は<a href=\"https://qiita.com/advent-calendar/2019/northdetail\">North Detail Advent Calendar 2019</a>17日目の記事です。</p>\n<p><em>※説明のためにいくつかコードを載せていますが、実際に作成したアプリのコード(Github)とは似て異なります。</em></p>\n<h2>概要</h2>\n<p>学生時代に手書きレポートの下書きをPCで打ち込んでいたのですが、実際にマス目に当てはめると段落の切り替えや、数字を1マスに2つ入れる...etcなどのルールがあったりして、文字数＝マス目の数にならないので、PCで下書きをして文字数を原稿用紙にあわせても、結局文章の長さが多すぎたり、逆に足りなかったりすることが多々ありました。\nということで、打ち込んだ文章を原稿用紙に当てはめたようにして表示するアプリを作成してみました。</p>\n<h2>作ったもの</h2>\n<ul>\n<li>入力した文章が原稿用紙に収まるかどうかを、実際にマス目に納めてカウントします。</li>\n<li>ログインするとカウントした結果を保存することができます。</li>\n<li>締切日を設定すると締め切り前日と当日にPush通知が届きます。(8:00と17:00に通知)</li>\n</ul>\n<p><img src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/538820/de3542d5-7b5f-635e-3c38-5d11d3c3e53b.png\" alt=\"スクリーンショット 2019-12-04 19.01.40（2）.png\">\n<img src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/538820/a9ae857f-336a-5aa3-bd04-ccbe8f39dda3.png\" alt=\"スクリーンショット 2019-12-04 19.02.23（2）.png\"></p>\n<p>文字数オーバーした箇所は赤いマスで表示されます。\n「段落の頭を1マス開ける」、「括弧を他の文字と同じますに入れる」など、実際の原稿用紙のルールに則った書式設定ができるので、打った文章が原稿用紙何枚分に収まるのかを確認することができます。</p>\n<ul>\n<li><a href=\"https://document-paper-counter-81e10.firebaseapp.com/\">Demo</a></li>\n<li><a href=\"https://github.com/shunsato1231/document-paper-counter\">Git</a></li>\n</ul>\n<h2>実装した機能と、実装内容の概要</h2>\n<h3>文字のカウント</h3>\n<ol>\n<li>入力した本文と、原稿用紙の書式設定をVuex Storeに格納</li>\n<li>Vuexのアクションで入力した文字を配列に分割し、(配列1つに原稿用紙ひとます分の文字を格納)Vuex Storeに格納</li>\n<li>配列に格納された文字を原稿用紙風に表示</li>\n</ol>\n<h3>カウントした文章の保存</h3>\n<p>入力した文章と、原稿用紙の書式設定をFireStoreにて管理。</p>\n<h3>通知処理</h3>\n<ol>\n<li>原稿用紙風に表示する画面で、「通知する」チェックボックスを押した時に通知用のトークンを取得</li>\n<li>保存時に、通知用のトークンを保存</li>\n<li>FirebaseFunctionsでpush通知を送信する関数を作成</li>\n<li>外部のCronを利用して、毎日8:00と17:00にFirebaseFunctionsで作成したpush通知を送信する関数を実行</li>\n</ol>\n<h2>実装の手順</h2>\n<p>大まかにですが、実装の手順について紹介しようと思います。</p>\n<h2>1. プロジェクトの作成</h2>\n<p>yarnがインストールされている前提です。</p>\n<h3>1-1. Vue Cliを使ってプロジェクト作成</h3>\n<pre><code class=\"hljs\">// vueCLIをインストール\nyarn global add @vue/cli\n\n// 新規プロジェクト作成\nvue create &lt;プロジェクト名&gt;</code></pre><p>上記コマンドでプロジェクトを作成。</p>\n<p>デフォルトのプリセットを使うか、手動で選択するかを聞かれるので <code>Manually select features</code> を選択。</p>\n<pre><code class=\"hljs\">? Please pick a preset: \n  default (babel, eslint) \n❯ Manually select features</code></pre><p>続く設問も下記のように選択。</p>\n<pre><code class=\"hljs\">? Check the features needed <span class=\"hljs-keyword\">for</span> your project: \n❯ ◉ Babel\n  ◯ TypeScript\n❯ ◉ Progressive Web App (PWA) Support\n❯ ◉ Router\n❯ ◉ Vuex\n❯ ◉ CSS Pre-processors\n❯ ◉ Linter / Formatter\n  ◯ Unit Testing\n  ◯ E2E Testing\n\n? Use <span class=\"hljs-built_in\">history</span> mode <span class=\"hljs-keyword\">for</span> router? (Requires proper server setup <span class=\"hljs-keyword\">for</span> index fallback <span class=\"hljs-keyword\">in</span> production)\n❯ Yes\n\n? Pick a CSS pre-processor (PostCSS, Autoprefixer and CSS Modules are supported by default)\n❯ Scss\n\n? Pick a linter / formatter config\n❯ ESLint with error prevention only \n\n? Pick additional lint features: (Press &lt;space&gt; to select, &lt;a&gt; to toggle all, &lt;i&gt; to invert selection)\n❯ Lint on save\n\n? Where <span class=\"hljs-keyword\">do</span> you prefer placing config <span class=\"hljs-keyword\">for</span> Babel, PostCSS, ESLint, etc.? \n❯ In dedicated config files</code></pre><p>これでVueプロジェクトの雛形が生成されるので、下記コマンドを実行するとアプリを立ち上げることができます。</p>\n<pre><code class=\"hljs\">// プロジェクトフォルダに移動\n<span class=\"hljs-built_in\">cd</span> &lt;プロジェクト名&gt;\n\n// ローカルで実行\nyarn run serve</code></pre><h3>1-2. Firebase導入</h3>\n<ul>\n<li><a href=\"https://firebase.google.com/?hl=ja\">Firebaseコンソール</a>にアクセスし、Firebaseのアカウントを作成</li>\n<li>Firebaseコンソール「新規プロジェクト作成」から新規プロジェクトを追加する。</li>\n<li>Firebaseをプロジェクトにインストール</li>\n</ul>\n<pre><code class=\"hljs\">//Firebaseインストール\n$ yarn global add firebase-tools\n\n// Googleアカウントでログイン\n$ firebase login\n\n// Firebaseの設定\n$ firebase init\n\n? Which Firebase CLI features <span class=\"hljs-keyword\">do</span> you want to setup <span class=\"hljs-keyword\">for</span> this folder? Press Space to select features, <span class=\"hljs-keyword\">then</span> Enter to confirm your choices.\n ◯ Database: Deploy Firebase Realtime Database Rules\n ◉ Firestore: Deploy rules and create indexes <span class=\"hljs-keyword\">for</span> Firestore\n ◉ Functions: Configure and deploy Cloud Functions\n ◉ Hosting: Configure and deploy Firebase Hosting sites\n ◯ Storage: Deploy Cloud Storage security rules\n\n? Select a default Firebase project <span class=\"hljs-keyword\">for</span> this directory: (Use arrow keys)\n❯ document-paper-counter-81e10 (document-paper-counter) // コンソールで作成したプロジェクト選択</code></pre><p>FireStoreの設定はデフォルトのまま</p>\n<pre><code class=\"hljs\">=== Firestore Setup\n\nFirestore Security Rules allow you to define how and when to allow\nrequests. You can keep these rules <span class=\"hljs-keyword\">in</span> your project directory\nand publish them with firebase deploy.\n\n? What file should be used <span class=\"hljs-keyword\">for</span> Firestore Rules? firestore.rules\n\n\nFirestore indexes allow you to perform complex queries <span class=\"hljs-keyword\">while</span>\nmaintaining performance that scales with the size of the result\n<span class=\"hljs-built_in\">set</span>. You can keep index definitions <span class=\"hljs-keyword\">in</span> your project directory\nand publish them with firebase deploy.\n\n? What file should be used <span class=\"hljs-keyword\">for</span> Firestore indexes? firestore.indexes.json\n\n\n=== Functions Setup\n\nA <span class=\"hljs-built_in\">functions</span> directory will be created <span class=\"hljs-keyword\">in</span> your project with a Node.js\npackage pre-configured. Functions can be deployed with firebase deploy.\n\n? What language would you like to use to write Cloud Functions? JavaScript\n? Do you want to use ESLint to catch probable bugs and enforce style? No\n✔  Wrote <span class=\"hljs-built_in\">functions</span>/package.json\n✔  Wrote <span class=\"hljs-built_in\">functions</span>/index.js\n✔  Wrote <span class=\"hljs-built_in\">functions</span>/.gitignore\n? Do you want to install dependencies with npm now? Yes</code></pre><p>Hostingの設定は下記のように設定</p>\n<pre><code class=\"hljs\">=== Hosting Setup\n\nYour public directory is the folder (relative to your project directory) that\nwill contain Hosting assets to be uploaded with firebase deploy. If you\nhave a build process for your assets, use your build's output directory.\n\n? What do you want to use as your public directory? dist\n? Configure as a single-page app (rewrite all urls to /index.html)? Yes</code></pre><ul>\n<li>config情報を管理画面から取得(今回はGitにコードをあげるために環境変数に格納)</li>\n<li>main.jsで<code>firebase.initializeApp</code>を実行</li>\n</ul>\n<pre><code class=\"hljs\">import firebase from 'firebase/app'\n\n// initialize Firebase\nlet config = {\n  apiKey: process.env.VUE_APP_FIRE_BASE_apiKey,\n  authDomain: process.env.VUE_APP_FIRE_BASE_authDomain,\n  databaseURL: process.env.VUE_APP_FIRE_BASE_databaseURL,\n  projectId: process.env.VUE_APP_FIRE_BASE_projectId,\n  storageBucket: process.env.VUE_APP_FIRE_BASE_storageBucket,\n  messagingSenderId: process.env.VUE_APP_FIRE_BASE_messagingSenderId,\n  appId: process.env.VUE_APP_FIRE_BASE_appId\n}\n\nfirebase.initializeApp(config)\n...略</code></pre><p>これで、Firebaseの初期設定ができました。</p>\n<h3>1-3. フォルダ構成</h3>\n<p>これらの手順で生成されたものを元に、大まかに下記のようなフォルダ構成で作成しました。</p>\n<pre><code>├── dist\n│   └── ビルド後に生成されるファイル\n│\n├── firebase.json\n├── firestore.indexes.json\n├── firestore.rules\n├── functions\n│   ├── index.js\n│   ├── package-lock.json\n│   └── package.json\n│\n├── public\n│   ├── 404.html\n│   ├── favicon.ico\n│   ├── firebase-messaging-sw.js\n│   ├── img\n│   │   └── icons\n│   ├── index.html\n│   ├── manifest.json\n│   └── robots.txt\n├── src\n│   ├── App.vue\n│   ├── main.js\n│   ├── registerServiceWorker.js\n│   ├── api\n│   │   └── firebase.js\n│   ├── assets\n│   │   └── scss\n│   │       └── entry.scss\n│   ├── components\n│   │   ├── dialog.vue\n│   │   └── head-menu.vue\n│   ├── pages\n│   │   ├── help.vue\n│   │   ├── input.vue\n│   │   ├── list.vue\n│   │   └── result.vue\n│   ├── router\n│   │   └── index.js\n│   └── store\n│       ├── index.js\n│       └── modules\n│           ├── auth.js\n│           ├── counter.js\n│           └── list.js\n└── vue.config.js\n</code></pre>\n<p><img src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/538820/935f9faa-6bc9-0050-ba08-8c1b879c9bf0.png\" alt=\"vuex.png\">\n引用元: https://vuex.vuejs.org/ja/</p>\n<p>上記の図の、<code>VueComponents</code>に当たる部分が<code>src/components</code>と<code>src/pages</code>になります。\n<code>vuex</code>に当たる部分が<code>store</code>内に格納されているものです。\n今回の場合、<code>BackendAPI</code>に当たる部分がFirebaseになるため、Firebaseに関する関数を<code>src/api/firebase.js</code>に集約し、<code>store</code>フォルダ内のコードから呼び出す方針で実装しました。</p>\n<h2>2. VueでUI部分を作成</h2>\n<p>今回ここについては省略します。</p>\n<h2>3. Authentication(ログイン処理)</h2>\n<p>今回はGoogleアカウントで認証できるように実装しました。</p>\n<pre><code class=\"hljs\">...略\n\n<span class=\"hljs-keyword\">const</span> auth = firebase.auth()\n\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> {\n  initFirebase () {\n    auth.onAuthStateChanged(<span class=\"hljs-keyword\">this</span>.onAuthStateChanged.bind(<span class=\"hljs-keyword\">this</span>))\n  },\n\n  login () {\n    <span class=\"hljs-keyword\">var</span> provider = <span class=\"hljs-keyword\">new</span> firebase.auth.GoogleAuthProvider()\n    auth.signInWithPopup(provider)\n  },\n\n  logout () {\n    auth.signOut()\n  },\n\n  onAuthStateChanged (user) {\n    <span class=\"hljs-keyword\">if</span> (user) {\n     <span class=\"hljs-comment\">// ユーザがログインしている時の処理</span>\n    } <span class=\"hljs-keyword\">else</span> {\n     <span class=\"hljs-comment\">// 未ログイン時の処理</span>\n    }\n  },\n\n...略</code></pre><p><code>main.js</code> に以下を追加</p>\n<pre><code class=\"hljs\">import Firebase from './api/firebase'\n\nFirebase.initFirebase()</code></pre><p>この処理だけでGoogleアカウントでの認証が完了しました。</p>\n<h2>4. FireStore(データベース)への書き込み</h2>\n<p>以前使われていたFirebaseRealtimeDatabaseではデータベース構造をjsonファイルで記述する必要がありましたが、FireStoreでは書き込みのルールのみ指定すれば、自由にカラムを作成できるようです。</p>\n<pre><code class=\"hljs\">...略\n<span class=\"hljs-keyword\">import</span> <span class=\"hljs-string\">'firebase/firestore'</span>\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> {\n  <span class=\"hljs-comment\">//例) 原稿のデータをfirestoreに保存する関数</span>\n  saveDocument (<span class=\"hljs-built_in\">document</span>) {\n    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =&gt;</span> {\n      <span class=\"hljs-keyword\">const</span> userId = VueCookies.get(<span class=\"hljs-string\">'userInfo'</span>).uid <span class=\"hljs-comment\">// cookieに保存しておいたユーザIDを取得</span>\n      database.collection(<span class=\"hljs-string\">'users'</span>).doc(userId).collection(<span class=\"hljs-string\">'documents'</span>)\n        .add(<span class=\"hljs-built_in\">document</span>)\n        .then(<span class=\"hljs-function\">(<span class=\"hljs-params\">ref</span>) =&gt;</span>  {\n          resolve(ref)\n        }).catch(reject)\n    })\n  },\n}</code></pre><h2>5. CloudMessagingを利用したPush通知</h2>\n<p>※Push通知に関してはSafariやiOS端末などでは非対応です。iPhoneでは通知を出せません。</p>\n<h3>5-1. PWA化をしてCloudMessagingを導入する</h3>\n<p>PWA化とCloudMessagingの導入に関しては、下記記事を参考に実装しました。</p>\n<ul>\n<li><a href=\"https://qiita.com/n11sh1/items/5d64c337ef927ac8d5d6#push-notifications\">Vue CLI 3 で PWA チュートリアル（Service Workers / Add to Home Screen / Push Notifications）</a></li>\n</ul>\n<p>注意点として、</p>\n<pre><code class=\"hljs\">... 略\n<span class=\"hljs-keyword\">let</span> messaging\n\n<span class=\"hljs-keyword\">if</span>(firebase.messaging.isSupported()) {\n  messaging = firebase.messaging()\n}\n\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> {\n  initFirebase () {\n    auth.onAuthStateChanged(<span class=\"hljs-keyword\">this</span>.onAuthStateChanged.bind(<span class=\"hljs-keyword\">this</span>))\n\n    <span class=\"hljs-keyword\">if</span> (firebase.messaging.isSupported()) {\n      messaging.usePublicVapidKey(process.env.VUE_APP_FIRE_BASE_publicVapidKey)\n      store.dispatch(<span class=\"hljs-string\">'auth/checkMessagingisSupported'</span>, <span class=\"hljs-literal\">true</span>)\n    } <span class=\"hljs-keyword\">else</span> {\n      store.dispatch(<span class=\"hljs-string\">'auth/checkMessagingisSupported'</span>, <span class=\"hljs-literal\">false</span>)\n    }\n  },\n...略</code></pre><p>上記のように<code>firebase.messaging.isSupported()</code>関数でCloudMessagingに対応した環境かどうかを判定しないと\niOS端末など、CloudMessageingが非対応の環境ではページがまっしろになってしまいます。</p>\n<h3>5-2. Push通知をするためのトークンを発行する</h3>\n<p>複数の端末でログインしても、全ての端末にpush通知が届くように、複数端末トークンを利用しました。</p>\n<p>参考ページ</p>\n<ul>\n<li>https://firebase.google.com/docs/cloud-messaging/js/device-group?hl=ja</li>\n</ul>\n<p>トークン追加のURLをそのまま叩くと、クロスドメイン制約に引っかかってしまうため、下記のエラーが出てしまいます。</p>\n<pre><code class=\"hljs\">Access-Control-Allow-Origin</code></pre><p>そこで、プロキシの設定をします。\n<code>vue.config.js</code>に下記の設定を追加。</p>\n<pre><code class=\"hljs\"><span class=\"hljs-built_in\">module</span>.exports = {\n    ...略\n    <span class=\"hljs-attr\">devServer</span>: {\n        <span class=\"hljs-attr\">proxy</span>: <span class=\"hljs-string\">'https://fcm.googleapis.com/'</span>,\n    }\n  }</code></pre><p>これで、\n<code>&lt;アプリが立ち上がっているサーバのドメイン&gt;/hoge/some</code>\nにリクエストを飛ばすと、devserverを経由して\n<code>https://fcm.googleapis.com/hoge/some</code>\nにリクエストが送信されるようになります。</p>\n<p>実際には、開発環境と本番環境でドメインが違うので、環境変数にドメインを格納します。</p>\n<p>.envファイルに本番環境のドメインを変数で追加</p>\n<pre><code class=\"hljs\">VUE_APP_API_URL_BASE=<span class=\"hljs-string\">\"&lt;デプロイする先のドメイン&gt;\"</span></code></pre><p>.env.developファイルに、開発環境(localhost)のドメインを追加</p>\n<pre><code class=\"hljs\">VUE_APP_API_URL_BASE=<span class=\"hljs-string\">\"http://localhost:8080\"</span></code></pre><p>これで、ドメイン部分を変数で指定すると、開発環境でも、本番環境でも、クロスドメイン制約に引っかかることなくリクエストを叩けるようになりました。</p>\n<pre><code class=\"hljs\">...略\n  <span class=\"hljs-comment\">// 通知用トークンの取得</span>\n  getNotinotificationKey () {\n    <span class=\"hljs-keyword\">const</span> userId = VueCookies.get(<span class=\"hljs-string\">'userInfo'</span>).uid\n    <span class=\"hljs-keyword\">const</span> url = process.env.VUE_APP_API_URL_BASE + <span class=\"hljs-string\">\"/fcm/notification?notification_key_name=\"</span> + userId\n    <span class=\"hljs-keyword\">let</span> headers = {\n      <span class=\"hljs-string\">'Content-Type'</span>:<span class=\"hljs-string\">'application/json'</span>,\n      <span class=\"hljs-string\">'Authorization'</span>: <span class=\"hljs-string\">'key='</span> + process.env.VUE_APP_FIRE_BASE_serverKey,\n      <span class=\"hljs-string\">'project_id'</span>: process.env.VUE_APP_FIRE_BASE_messagingSenderId\n    }\n    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =&gt;</span> {\n      axios.get(url, {<span class=\"hljs-attr\">headers</span>: headers, <span class=\"hljs-attr\">data</span>: {}})\n        .then(<span class=\"hljs-function\"><span class=\"hljs-params\">res</span> =&gt;</span> {\n          resolve(res.data)\n        }).catch(<span class=\"hljs-function\"><span class=\"hljs-params\">err</span> =&gt;</span> {\n          reject(err)\n        })\n    })\n  },\n...略</code></pre><h3>5-3. CloudFunctionsで通知を送るfunctionを作成</h3>\n<p><code>functions/index.js</code> に通知を送信するfunctionを作成して、deployします。</p>\n<pre><code class=\"hljs\"><span class=\"hljs-comment\">// firestoreにから通知対象のデータと、トークンを取得</span>\n<span class=\"hljs-keyword\">async</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">getNotificationDocument</span> (<span class=\"hljs-params\"></span>) </span>{\n  <span class=\"hljs-keyword\">try</span> {\n    <span class=\"hljs-comment\">// notificationListに通知するデータを格納済み</span>\n    <span class=\"hljs-keyword\">const</span> querySnapshot = <span class=\"hljs-keyword\">await</span> database.collection(<span class=\"hljs-string\">'notificationList'</span>).get()\n\n    <span class=\"hljs-keyword\">return</span> querySnapshot.docs.filter(<span class=\"hljs-function\"><span class=\"hljs-params\">doc</span> =&gt;</span> {\n      <span class=\"hljs-keyword\">return</span> moment().isSame(doc.data().deadline, <span class=\"hljs-string\">'day'</span>)\n    }).map(<span class=\"hljs-function\"><span class=\"hljs-params\">doc</span> =&gt;</span> {\n      <span class=\"hljs-keyword\">return</span> {\n        <span class=\"hljs-attr\">notificationKey</span>: doc.data().notificationKey,\n        <span class=\"hljs-attr\">title</span>: doc.data().title,\n        <span class=\"hljs-attr\">id</span>: doc.id\n      }\n    })\n  } <span class=\"hljs-keyword\">catch</span> (error) {\n    <span class=\"hljs-keyword\">throw</span> error\n  }\n}\n\n<span class=\"hljs-comment\">// push通知を送信する</span>\n<span class=\"hljs-keyword\">async</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">DeadlineDocument</span>(<span class=\"hljs-params\">documents</span>) </span>{\n  <span class=\"hljs-keyword\">const</span> url = <span class=\"hljs-string\">\"https://fcm.googleapis.com/fcm/send\"</span>\n  <span class=\"hljs-keyword\">const</span> headers = {\n    <span class=\"hljs-string\">'Authorization'</span>: <span class=\"hljs-string\">'key='</span> + functions.config().vue_app.server_key,\n  }\n\n  <span class=\"hljs-keyword\">try</span>{\n    <span class=\"hljs-keyword\">for</span>(<span class=\"hljs-keyword\">let</span> <span class=\"hljs-built_in\">document</span> <span class=\"hljs-keyword\">of</span> documents) {\n      <span class=\"hljs-keyword\">let</span> data = {\n        <span class=\"hljs-string\">\"notification\"</span>: {\n          <span class=\"hljs-string\">\"title\"</span>: <span class=\"hljs-string\">\"「\"</span> + <span class=\"hljs-built_in\">document</span>.title + <span class=\"hljs-string\">\"」は今日締め切りです\"</span>, <span class=\"hljs-comment\">//通知のタイトル</span>\n          <span class=\"hljs-string\">\"click_action\"</span>: <span class=\"hljs-string\">\"result/\"</span> + <span class=\"hljs-built_in\">document</span>.id <span class=\"hljs-comment\">//通知を押した時の飛び先</span>\n        },\n        <span class=\"hljs-string\">\"to\"</span>: <span class=\"hljs-built_in\">document</span>.notificationKey <span class=\"hljs-comment\">//トークン</span>\n      }\n\n      axios.post(url, data, {<span class=\"hljs-attr\">headers</span>: headers, <span class=\"hljs-attr\">useCredentails</span>: <span class=\"hljs-literal\">true</span>})\n\n      <span class=\"hljs-keyword\">await</span> sleep(<span class=\"hljs-number\">2000</span>)\n    }\n\n    <span class=\"hljs-keyword\">return</span> documents\n  } <span class=\"hljs-keyword\">catch</span> (error) {\n    <span class=\"hljs-keyword\">throw</span> error.response.status\n  }\n}\n\n<span class=\"hljs-comment\">// デプロイする関数</span>\nexports.pushNotification = functions.https.onRequest(<span class=\"hljs-keyword\">async</span> (request, response) =&gt; {\n  <span class=\"hljs-keyword\">try</span>{\n    <span class=\"hljs-keyword\">const</span> res = <span class=\"hljs-keyword\">await</span> getNotificationDocument()\n    <span class=\"hljs-keyword\">const</span> today = <span class=\"hljs-keyword\">await</span> pushNotificationTodaysDeadlineDocument(res.today)\n    response.send(today)\n  } <span class=\"hljs-keyword\">catch</span> (error) {\n    response.status(<span class=\"hljs-number\">500</span>).send(error)\n  }\n})</code></pre><p>下記コマンドでfunctionをデプロイ</p>\n<pre><code class=\"hljs\">$ firebase deploy --only <span class=\"hljs-built_in\">functions</span>\n\nFunction URL (addMessage): https://MY_PROJECT.cloudfunctions.net/pushNotification</code></pre><p>FunctionURLをブラウザで開いて、push通知が送信されれば成功です◎</p>\n<h3>5-4. Cronで関数を定期実行</h3>\n<p>Firebaseのみで定期実行をすることができますが、課金が必要です。\nhttps://firebase.google.com/docs/functions/schedule-functions</p>\n<p>今回は、無料で実装したかったため、外部のCronを利用しました。</p>\n<ul>\n<li><a href=\"https://cron-job.org/en/\">cron-job.org</a>にアクセスし、TOP画面でサインアップする</li>\n<li>「Cronjobs」タブの「+Create cronjob」ボタンを押して、新規jobを作成</li>\n<li>titleとFunctionURL、任意のスケジュールを設定し、jobを作成</li>\n</ul>\n<p>これで設定がうまくいっていれば、設定したスケジュールで通知されます🎉</p>\n<h2>感想</h2>\n<p>CloudMessagingは初めて利用しましたが、想像以上に簡単にpush通知を実装することができました。\nPWA化もVueCLIを利用すれば、手間無く実装できました。</p>\n<p>PWAはiOSの対応状況が芳しくないので、今後に期待です。。。😔</p>\n<p>原稿用紙の表示部分は思いつきとチカラワザで実装したので、バグがあるかもしれないです。。\n不具合など見つけたらご指摘いただけると助かりますm(_ _)m</p>\n",
  "dir": "contents/blog/json",
  "base": "2019-12-docment-counter.json",
  "ext": ".json",
  "sourceBase": "2019-12-docment-counter.md",
  "sourceExt": ".md"
}